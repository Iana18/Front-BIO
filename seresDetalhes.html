<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Ser</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fafafa; color: #386b3a; padding: 20px; }
        .card { max-width: 800px; margin: 0 auto; }
        .card img { object-fit: cover; height: 300px; }
        .info-label { font-weight: 600; }
        .info-value { margin-left: 8px; }
    </style>
</head>
<body>

<div id="detalhesSer" class="card shadow-sm">
    <img id="serImg" src="assets/images/default.png" class="card-img-top" alt="Imagem do ser">
    <div class="card-body">
        <h3 id="serNome"></h3>
        <p id="serDescricao"></p>
        <p><span class="info-label">Espécie:</span><span id="serEspecie" class="info-value"></span></p>
        <p><span class="info-label">Tipo:</span><span id="serTipo" class="info-value"></span></p>
        <p><span class="info-label">Status de Conservação:</span><span id="serStatus" class="info-value"></span></p>
        <p><span class="info-label">Registrado Por:</span><span id="serRegistrado" class="info-value"></span></p>
        <p><span class="info-label">Aprovado Por:</span><span id="serAprovado" class="info-value"></span></p>
        <p><span class="info-label">Data de Registro:</span><span id="serDataRegistro" class="info-value"></span></p>
        <p><span class="info-label">Data de Aprovação:</span><span id="serDataAprovacao" class="info-value"></span></p>
        <p><span class="info-label">Localização:</span><span id="serLocalizacao" class="info-value"></span></p>
    </div>
</div>

<script>
async function carregarDetalhes() {
    const params = new URLSearchParams(window.location.search);
    const serId = params.get('id');
    if (!serId) return alert("ID do ser não fornecido");

    try {
        const res = await fetch(`http://localhost:8080/api/seres/${serId}`);
        const ser = await res.json();

        document.getElementById('serNome').innerText = `${ser.nomeComum} (${ser.nomeCientifico})`;
        document.getElementById('serDescricao').innerText = ser.descricao || '—';
        document.getElementById('serEspecie').innerText = ser.especie ? ser.especie.nome : '—';
        document.getElementById('serTipo').innerText = ser.tipo ? ser.tipo.nome : '—';
        document.getElementById('serStatus').innerText = ser.statusConservacao || '—';
        document.getElementById('serRegistrado').innerText = ser.registradoPor ? ser.registradoPor.login : '—';
        document.getElementById('serAprovado').innerText = ser.aprovadoPor ? ser.aprovadoPor.login : '—';
        document.getElementById('serDataRegistro').innerText = ser.dataRegistro || '—';
        document.getElementById('serDataAprovacao').innerText = ser.dataAprovacao || '—';

        // Localização via cache e OpenStreetMap
        let locationName = '—';
        if (window.locationCache) window.locationCache = window.locationCache || {};
        if (window.locationCache[ser.id]) {
            locationName = window.locationCache[ser.id];
        } else if (ser.latitude && ser.longitude) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${ser.latitude}&lon=${ser.longitude}&format=json`);
                const data = await response.json();
                locationName = data.display_name || '—';
                window.locationCache[ser.id] = locationName;
            } catch {}
        }
        document.getElementById('serLocalizacao').innerText = locationName;

        // Imagem
        let imagemSrc = 'assets/images/default.png';
        try {
            const imgRes = await fetch(`http://localhost:8080/api/seres/${ser.id}/imagem`);
            if (imgRes.ok) {
                const base64 = await imgRes.text();
                if (base64) imagemSrc = `data:image/jpeg;base64,${base64}`;
            }
        } catch {}
        document.getElementById('serImg').src = imagemSrc;

    } catch (err) {
        console.error(err);
        alert("Erro ao carregar detalhes do ser.");
    }
}

window.addEventListener("DOMContentLoaded", carregarDetalhes);
</script>

</body>
</html>
